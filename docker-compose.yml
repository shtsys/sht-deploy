# ============================================
# SHT 系统 Docker 一键部署配置
# ============================================
# 使用方法:
#   1. 复制 .env.example 为 .env 并修改配置
#   2. 执行 docker compose up -d
# ============================================

services:
  # ============ 前端 Web 服务 ============
  sht-web:
    image: shtsys/sht-web:${VERSION:-latest}
    container_name: sht-web
    restart: always
    ports:
      - "${WEB_PORT:-8091}:80"
    depends_on:
      sht-api:
        condition: service_healthy
    networks:
      - sht-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost/",
        ]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============ 后端 API 服务 ============
  sht-api:
    image: shtsys/sht-api:${VERSION:-latest}
    container_name: sht-api
    restart: always
    ports:
      - "${API_PORT:-8090}:8085"
    environment:
      - PROJECT_NAME=${PROJECT_NAME:-sht_manage}
      - MYSQL_HOST=${MYSQL_HOST:-mysql}
      - MYSQL_PORT=${MYSQL_PORT:-3306}
      - MYSQL_DB=${MYSQL_DB:-sht_data}
      - MYSQL_USER=${MYSQL_USER:-root}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_ENGINE=${MYSQL_ENGINE:-django_mysql_geventpool.backends.mysql}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - ENCRYPT_STRING=${ENCRYPT_STRING:-c-QULHn+u=-BUSQ$}
      - DEBUG=${DEBUG:-False}
      - TZ=${TZ:-Asia/Shanghai}
    volumes:
      # 应用数据挂载到宿主机目录
      - /docker-data/sht/logs:/app/logs
      - /docker-data/sht/media:/app/media
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/machine-id:/host/etc/machine-id:ro
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - sht-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/health/"]
      interval: 30s
      timeout: 10s
      start_period: 120s
      retries: 3

  # ============ MySQL 数据库 ============
  mysql:
    image: mysql:8.0
    container_name: sht-mysql
    restart: always
    ports:
      - "${MYSQL_EXPOSE_PORT:-3306}:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DB:-sht_data}
      - TZ=${TZ:-Asia/Shanghai}
    volumes:
      - mysql-data:/var/lib/mysql
      - mysql-logs:/var/log/mysql
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-time-zone=+8:00
      - --max_connections=200
      - --max_allowed_packet=64M
    networks:
      - sht-network
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "root",
          "-p${MYSQL_PASSWORD}",
        ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # ============ Redis 缓存 ============
  redis:
    image: redis:6.2-alpine
    container_name: sht-redis
    restart: always
    ports:
      - "${REDIS_EXPOSE_PORT:-6379}:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD} --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - sht-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

# ============ 网络配置 ============
networks:
  sht-network:
    name: sht-network
    driver: bridge

# ============ 数据卷 ============
volumes:
  mysql-data:
    name: sht-mysql-data
  mysql-logs:
    name: sht-mysql-logs
  redis-data:
    name: sht-redis-data
